<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caisse â€“ Bar (commande + paiement repliable)</title>

<!-- âœ… PWA manifest -->
<link rel="manifest" href="/caisse-bar/manifest.webmanifest">
<meta name="theme-color" content="#0f1217">

<!-- âœ… IcÃ´ne iPhone (conseillÃ©) -->
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- (Optionnel, pour rester discret) -->
<meta name="robots" content="noindex,nofollow">

<style>
  :root{--bg:#0f1217;--panel:#171b22;--text:#e6e9ef;--muted:#9aa3b2;--accent:#3b82f6;--warn:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:12px;background:var(--panel);display:flex;justify-content:space-between;align-items:center;gap:8px}
  h1{margin:0;font-size:18px}
  .btn{height:32px;border-radius:10px;border:1px solid #243042;background:#0b1016;color:#fff;padding:0 10px;cursor:pointer}
  .btn.warn{background:#2a1515;border-color:#3a2222;color:#ffb4b4}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}

  /* Tabs */
  .tabs{display:flex;gap:6px;overflow:auto;padding:8px 12px;background:#0e131a;border-bottom:1px solid #222833}
  .tab{padding:6px 12px;border-radius:999px;border:1px solid #243042;background:#0b1016;color:var(--text);cursor:pointer;white-space:nowrap;font-size:14px}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  /* Grid produits */
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;padding:12px}
  .item{appearance:none;-webkit-appearance:none;border:1px solid #222833;background:#0e131a;color:inherit;border-radius:12px;padding:10px;cursor:pointer;position:relative;text-align:center}
  .item .emo{display:block;font-size:24px;margin-bottom:4px}
  .item .badge{position:absolute;top:6px;right:6px;background:var(--accent);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;display:none}
  .badge.edit{position:absolute;top:6px;left:6px;background:#10b981;color:#062;display:none}
  body.admin .item .badge.edit{display:inline-block}

  /* Panneaux */
  .panel{background:var(--panel);margin:12px;border-radius:12px;padding:12px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .big{font-size:26px;font-weight:800}
  .muted{color:var(--muted);font-size:12px}
  .chev{font-size:16px;color:var(--muted)}
  #details,#paymentBody{margin-top:8px;border-top:1px dashed #243042;padding-top:8px}
  .line{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:6px 0}
  .remove{border:1px solid #3a2222;background:#2a1515;color:#ffb4b4;border-radius:8px;height:24px;padding:0 6px;cursor:pointer}

  /* Paiement */
  .payrow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  input.payin{width:100%;height:36px;border-radius:10px;border:1px solid #243042;background:#0b1016;color:#fff;padding:0 8px;font-size:16px}
  .quickcash{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{border:1px solid #243042;padding:4px 8px;border-radius:999px;font-size:12px}
  .denoms{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}

  /* Ã‰vite le double-tap zoom et les flashs bleus sur iOS */
  html, body { touch-action: manipulation; }
  .item, .btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  .item, .btn { -webkit-user-select: none; user-select: none; }

  /* Admin modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#11161f;border:1px solid #243042;border-radius:12px;padding:16px;min-width:280px;max-width:92vw}
  .modal h3{margin:0 0 8px;font-size:16px}
  .modal .row2{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:8px}
  input.min{height:32px;border-radius:8px;border:1px solid #243042;background:#0b1016;color:#fff;padding:0 8px}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{border-bottom:1px solid #243042;padding:6px;text-align:left;font-size:14px}
  .table input{width:100%;height:30px;border-radius:8px;border:1px solid #243042;background:#0b1016;color:#fff;padding:0 6px}
</style>
</head>
<body>

  <header>
    <h1>ğŸ¹ Foyer - Bar</h1>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="btn warn" id="clear">Vider la commande</button>
      <button class="btn" id="btnAdmin">Mode gÃ©rant</button>
    </div>
  </header>

  <!-- Onglets -->
  <div class="tabs" id="tabs"></div>

  <!-- Zone produits -->
  <div class="grid" id="grid"></div>

  <!-- Totaux + dÃ©tail -->
  <div class="panel" id="totalsPanel">
    <div class="row">
      <div>
        <div class="muted">Total</div>
        <div class="big" id="totalTxt">0,00 â‚¬</div>
      </div>
      <div>
        <div class="muted">Articles</div>
        <div class="big"><span id="countTxt">0</span> <span class="chev" id="chev">â–¸</span></div>
      </div>
    </div>
    <div id="details" hidden></div>
  </div>

  <!-- Paiement repliable -->
  <div class="panel" id="paymentPanel">
    <div class="row">
      <div><strong>ğŸ’¶ Paiement</strong></div>
      <div class="chev" id="chevPay">â–¸</div>
    </div>
    <div id="paymentBody" hidden>
      <div class="payrow">
        <input class="payin" id="cashGiven" placeholder="Montant donnÃ© (ex: 10,00)" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*">
        <button class="btn primary" id="calcChange">Calculer</button>
      </div>
      <div class="quickcash" id="quickCash"></div>
      <div id="changeBox" hidden>
        <div><strong>Rendu :</strong> <span id="changeTxt">0,00 â‚¬</span></div>
        <div class="denoms" id="denomsBox"></div>
      </div>
    </div>
  </div>

  <!-- ====== Script principal (catalogue + vente + paiement) ====== -->
  <script>
  /* ====== Utils monnaie ====== */
  const fmt = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
  const toC = v => Math.round(parseFloat(String(v).replace(',','.'))*100);
  const fromC = c => fmt.format(c/100);

  /* ====== DonnÃ©es : catalogue par dÃ©faut ====== */
  const DEFAULT_CATALOG = {
    "â˜• Chauds": [
      {id:"cafe",name:"CafÃ©",price:0.50,emo:"â˜•"},
      {id:"infusion",name:"Infusion",price:0.20,emo:"ğŸµ"},
      {id:"choco",name:"Chocolat chaud",price:0.50,emo:"ğŸ«"}
    ],
    "ğŸ¥¤ FraÃ®ches": [
      {id:"boitage",name:"Boitage (canettes)",price:0.80,emo:"ğŸ¥¤"},
      {id:"jus",name:"Jus de fruits",price:0.90,emo:"ğŸ§ƒ"},
      {id:"eau-plate",name:"Eau plate",price:0.30,emo:"ğŸ’§"},
      {id:"eau-gaz",name:"Eau gazeuse",price:0.70,emo:"ğŸ’¦"},
      {id:"limonade-verre",name:"Limonade (verre)",price:0.20,emo:"ğŸ¥¤"},
      {id:"limonade-btl",name:"Limonade (bouteille)",price:1.20,emo:"ğŸ«™"},
      {id:"redbull",name:"Red Bull",price:1.50,emo:"ğŸª½"}
    ],
    "ğŸº BiÃ¨res": [
      {id:"biere-spe",name:"BiÃ¨res spÃ©ciales",price:2.00,emo:"ğŸ»"},
      {id:"pelforth-pression",name:"Pelforth pression",price:1.00,emo:"ğŸº"},
      {id:"lindemans-pression",name:"Lindemans pression",price:1.50,emo:"ğŸº"},
      {id:"hoegaarden-btl",name:"Hoegaarden",price:1.00,emo:"ğŸº"},
      {id:"grimbergen-btl",name:"Grimbergen",price:1.00,emo:"ğŸº"},
      {id:"heineken-btl",name:"Heineken",price:1.00,emo:"ğŸº"},
      {id:"1664-btl",name:"1664",price:1.00,emo:"ğŸº"},
      {id:"leffe-btl",name:"Leffe",price:1.00,emo:"ğŸº"},
      {id:"desperados-btl",name:"Despe",price:1.50,emo:"ğŸº"},
      {id:"tourtel",name:"Tourtel Twist",price:1.00,emo:"ğŸº"}
    ],
    "ğŸ· Vins": [
      {id:"rose-verre",name:"Vin rosÃ© (verre)",price:0.60,emo:"ğŸ·"},
      {id:"blanc-verre",name:"Vin blanc (verre)",price:0.90,emo:"ğŸ¥‚"},
      {id:"rose-btl",name:"Vin rosÃ© (btl)",price:4.50,emo:"ğŸ·"},
      {id:"blanc-btl",name:"Vin blanc (btl)",price:6.75,emo:"ğŸ¥‚"},
      {id:"crs-or",name:"Vin Cie Or",price:6.00,emo:"ğŸ¾"},
      {id:"crs-rouge",name:"Vin Cie Rouge",price:8.00,emo:"ğŸ¾"},
      {id:"beaujolais",name:"Beaujolais",price:4.50,emo:"ğŸ·"},
      {id:"champagne",name:"Champagne",price:18.00,emo:"ğŸ¾"}
    ],
    "ğŸ¬ Confiseries": [
      {id:"cotedor",name:"CÃ´te d'Or",price:1.00,emo:"ğŸ«"},
      {id:"kitkat",name:"KitKat",price:0.50,emo:"ğŸ«"},
      {id:"bounty",name:"Bounty",price:0.50,emo:"ğŸ¥¥"},
      {id:"mars",name:"Mars",price:0.50,emo:"ğŸ«"},
      {id:"snickers",name:"Snickers",price:0.50,emo:"ğŸ«"},
      {id:"lion",name:"Lion",price:0.50,emo:"ğŸ«"},
      {id:"bueno",name:"Kinder Bueno",price:0.70,emo:"ğŸ«"},
      {id:"suchard",name:"Rocher Suchard",price:0.70,emo:"ğŸ«"}
    ],
    "ğŸš¬ Cigarettes": [
      {id:"marlboro-red",name:"Marlboro Red",price:13.00,emo:"ğŸš¬"},
      {id:"marlboro-gold",name:"Marlboro Gold",price:13.00,emo:"ğŸš¬"},
      {id:"philip-morris",name:"Philip Morris",price:12.50,emo:"ğŸš¬"}
    ],
    "ğŸ¥¨ Snacks": [
      {id:"gateau-ap",name:"GÃ¢teau apÃ©ritif",price:1.30,emo:"ğŸ¥¨"},
      {id:"saucisson",name:"Saucisson",price:4.00,emo:"ğŸ–"},
      {id:"fuet",name:"Fuet / barquette",price:3.00,emo:"ğŸ–"}
    ],
    "ğŸ§º Divers": [
      {id:"dose-lessive",name:"Dose lessive",price:0.60,emo:"ğŸ§¼"},
      {id:"jeton-machine",name:"Jeton machine",price:1.60,emo:"ğŸª™"},
      {id:"papier-toilette",name:"Papier toilette",price:0.40,emo:"ğŸ§»"},
      {id:"mousse-raser",name:"Mousse Ã  raser",price:2.00,emo:"ğŸª’"}
    ],
    "ğŸ‘• Utilitaire CRS": [
      {id:"calot",name:"Calot",price:26.00,emo:"ğŸ“"},
      {id:"flamme-calot",name:"Flamme de calot",price:3.50,emo:"ğŸ”¥"},
      {id:"galon-poitrine",name:"Galon poitrine",price:3.20,emo:"ğŸ–ï¸"},
      {id:"manchon",name:"Manchon",price:7.00,emo:"ğŸ§¤"},
      {id:"galon-calot-gd",name:"Galon calot GD",price:3.00,emo:"ğŸ–ï¸"},
      {id:"tee-crs",name:"Tee-shirt",price:8.10,emo:"ğŸ‘•"},
      {id:"tee-crs8-brode",name:"Tee-shirt brodÃ©",price:11.00,emo:"ğŸ‘•"},
      {id:"polo-crs",name:"Polo",price:20.00,emo:"ğŸ‘•"},
      {id:"pucelle",name:"Pucelle",price:7.00,emo:"ğŸ–ï¸"},
      {id:"medaille",name:"MÃ©daille",price:20.00,emo:"ğŸ…"},
      {id:"temoin",name:"TÃ©moin chambre vide",price:3.00,emo:"ğŸªª"},
      {id:"pince-cravate",name:"Pince cravate",price:8.00,emo:"ğŸ‘”"}
    ]
  };

  /* ====== Admin / Catalogue persistant ====== */
  const LS_KEY = 'caisse-bar.catalog.v1';
  const MANAGER_PIN = '4321'; // <-- change-moi

  // Catalogue courant
  let categories = (()=>{
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(DEFAULT_CATALOG);
      const obj = JSON.parse(raw);
      return (obj && typeof obj==='object') ? obj : structuredClone(DEFAULT_CATALOG);
    }catch{
      return structuredClone(DEFAULT_CATALOG);
    }
  })();

  function saveCatalog(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(categories)); }
    catch(e){ alert("Impossible de sauvegarder le catalogue."); }
  }

  /* ====== Ã‰tat : compteurs ====== */
  const counters = {};
  Object.values(categories).flat().forEach(p=>counters[p.id]=0);

  /* ====== DOM ====== */
  const $tabs=document.getElementById('tabs');
  const $grid=document.getElementById('grid');
  const $totalTxt=document.getElementById('totalTxt');
  const $countTxt=document.getElementById('countTxt');
  const $details=document.getElementById('details');
  const $totalsPanel=document.getElementById('totalsPanel');
  const $chev=document.getElementById('chev');
  const $clear=document.getElementById('clear');
  const $paymentPanel=document.getElementById('paymentPanel');
  const $chevPay=document.getElementById('chevPay');
  const $paymentBody=document.getElementById('paymentBody');
  const $cashGiven=document.getElementById('cashGiven');
  const $quickCash=document.getElementById('quickCash');
  const $changeBox=document.getElementById('changeBox');
  const $changeTxt=document.getElementById('changeTxt');
  const $denomsBox=document.getElementById('denomsBox');

  let activeCat = Object.keys(categories)[0] || '';

  /* ====== Onglets ====== */
  function renderTabs(){
    $tabs.innerHTML="";
    Object.keys(categories).forEach(cat=>{
      const b=document.createElement('button');
      b.className='tab'+(cat===activeCat?' active':'');
      b.textContent=cat;
      b.onclick=()=>{activeCat=cat;renderTabs();renderGrid();};
      $tabs.appendChild(b);
    });
  }

  /* ====== Grille produits ====== */
  function renderGrid(){
    $grid.innerHTML="";
    (categories[activeCat] || []).forEach(p=>{
      const btn=document.createElement('button');
      btn.type='button'; btn.className='item'; btn.dataset.id=p.id;
      btn.innerHTML=`
        <span class="badge">0</span>
        <span class="badge edit">âœ</span>
        <span class="emo">${p.emo}</span>${p.name}<br>${fromC(toC(p.price))}
      `;
      btn.onclick=()=>{ counters[p.id]++; updateTotals(); };
      $grid.appendChild(btn);
    });
    updateTotals();
  }

  /* ====== Totaux + dÃ©tail ====== */
  function updateTotals(){
    let total=0,count=0;
    Object.values(categories).flat().forEach(p=>{
      const q=counters[p.id]||0; total+=toC(p.price)*q; count+=q;
      const badge=document.querySelector(`[data-id="${p.id}"] .badge`);
      if(badge){ badge.textContent=q; badge.style.display=q>0?'inline-block':'none'; }
    });
    $totalTxt.textContent=fromC(total);
    $countTxt.textContent=count;
    renderDetails();
  }

  function renderDetails(){
    const lines=[];
    Object.values(categories).flat().forEach(p=>{
      const q=counters[p.id]; if(q<=0) return;
      lines.push(`<div class="line" data-id="${p.id}">
        <div>${p.emo} ${p.name} <span class="muted">Ã— ${q}</span></div>
        <div class="muted">${fromC(toC(p.price))}</div>
        <div><strong>${fromC(toC(p.price)*q)}</strong> <button class="remove" title="Retirer 1">âœ–</button></div>
      </div>`);
    });
    $details.innerHTML=lines.join("")||"<div class='muted'>Aucun article</div>";
  }

  /* Ouvrir/fermer le dÃ©tail (clic sur TOTAL) */
  $totalsPanel.addEventListener("click",(e)=>{
    if(e.target.closest(".remove")) return; // Ã©vite de replier si on clique âœ–
    const open=!$details.hasAttribute("hidden");
    if(open){$details.setAttribute("hidden","");$chev.textContent="â–¸";}
    else{$details.removeAttribute("hidden");$chev.textContent="â–¾";}
  });

  /* Retirer 1 avec âœ– (sans fermer) */
  $details.addEventListener("click",(e)=>{
    const rm=e.target.closest(".remove");
    if(!rm) return;
    e.stopPropagation();
    const line=e.target.closest(".line");
    const id=line?.dataset.id;
    if(!id) return;
    if(counters[id]>0){ counters[id]--; updateTotals(); }
  });

  /* Vider */
  $clear.addEventListener('click', ()=>{
    Object.keys(counters).forEach(k=>counters[k]=0);
    updateTotals();
    if(!$details.hasAttribute('hidden')) renderDetails();

    // Paiement => reset
    if ($cashGiven) $cashGiven.value = '';
    if ($changeBox) $changeBox.hidden = true;
    if ($changeTxt) $changeTxt.textContent = '0,00 â‚¬';
    if ($denomsBox) $denomsBox.innerHTML = '';

    // Replier Paiement si ouvert
    if (!$paymentBody.hasAttribute("hidden")) {
      $paymentBody.setAttribute("hidden","");
      $chevPay.textContent="â–¸";
    }
  });

  /* ====== Paiement repliable ====== */
  $paymentPanel.addEventListener("click",(e)=>{
    if(e.target.closest("input") || e.target.closest("button")) return;
    const open=!$paymentBody.hasAttribute("hidden");
    if(open){$paymentBody.setAttribute("hidden","");$chevPay.textContent="â–¸";}
    else{$paymentBody.removeAttribute("hidden");$chevPay.textContent="â–¾";}
  });

  // Raccourcis montants (inclut 0,10â‚¬ et 0,20â‚¬)
  const QUICK=[0.10,0.20,0.50,1,2,5,10,20,50];
  $quickCash.innerHTML=QUICK.map(v=>`<button class="btn" data-v="${v}">+${String(v).replace('.',',')}â‚¬</button>`).join('');
  $quickCash.addEventListener("click",(e)=>{
    const b=e.target.closest("button"); if(!b) return;
    const cur=parseFloat(($cashGiven.value||"0").replace(",", "."))||0;
    const nv=Math.round((cur + parseFloat(b.dataset.v))*100)/100;
    $cashGiven.value=String(nv).replace(".", ",");
  });

  // Calcul du rendu (dÃ©composition inclut 0,20â‚¬ et 0,10â‚¬)
  document.getElementById("calcChange").addEventListener("click",()=>{
    let total=0; Object.values(categories).flat().forEach(p=> total += toC(p.price)*(counters[p.id]||0));
    const given = toC(($cashGiven.value || "0").replace(/\s/g,""));
    const change = given - total;
    $changeBox.hidden = false;
    if(change < 0){
      $changeTxt.textContent = `Montant insuffisant (manque ${fromC(-change)})`;
      $denomsBox.innerHTML = "";
      return;
    }
    $changeTxt.textContent = fromC(change);
    const denoms = [20000,10000,5000,2000,1000,500,200,100,50,20,10,5]; // 200â‚¬, ... , 0,05â‚¬
    let rest = change; const chips=[];
    for(const d of denoms){ const n=Math.floor(rest/d); if(n>0){ chips.push(`${n} Ã— ${fromC(d)}`); rest-=n*d; } }
    $denomsBox.innerHTML = chips.map(c=>`<span class="chip">${c}</span>`).join('');
  });

  /* ====== Init ====== */
  renderTabs(); renderGrid();
  </script>

  <!-- SW (optionnel) -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('/caisse-bar/sw.js', { scope: '/caisse-bar/' })
        .then(() => console.log("âœ… SW caisse-bar enregistrÃ©"))
        .catch(err => console.error("âŒ Erreur SW caisse-bar", err));
    });
  }
  </script>

  <!-- Pare-feu SW racine -->
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => {
      for (const reg of regs) {
        const scope = new URL(reg.scope).pathname;
        if (location.pathname.startsWith('/caisse-bar/') && scope === '/') {
          console.log('ğŸ§¹ Suppression dâ€™un ancien SW racine parasite');
          reg.unregister();
        }
      }
    });
  }
  </script>

  <!-- iOS anti double-tap zoom -->
  <script>
  let lastTouch = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouch <= 300) e.preventDefault();
    lastTouch = now;
  }, { passive: false });
  document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });
  </script>

  <!-- ====== Modale Admin ====== -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="box">
      <h3>ğŸ” AccÃ¨s gÃ©rant</h3>
      <div class="row2">
        <input id="pinInput" class="min" type="password" placeholder="PIN gÃ©rant">
        <button class="btn primary" id="pinOk">Entrer</button>
      </div>
      <div id="adminBody" style="margin-top:10px;display:none">
        <div class="row" style="gap:6px;flex-wrap:wrap">
          <button class="btn primary" id="editCatalogue">Ã‰diter le catalogue</button>
          <button class="btn" id="exportCat">Exporter JSON</button>
          <label class="btn"><input type="file" id="importCat" accept="application/json" style="display:none">Importer JSON</label>
          <button class="btn warn" id="logoutAdmin">Quitter le mode</button>
        </div>
        <div id="editorZone"></div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn" id="closeAdmin">Fermer</button>
      </div>
    </div>
  </div>

  <!-- ====== Script Admin (aprÃ¨s la modale) ====== -->
  <script>
  const $btnAdmin   = document.getElementById('btnAdmin');
  const $modal      = document.getElementById('adminModal');
  const $pinInput   = document.getElementById('pinInput');
  const $pinOk      = document.getElementById('pinOk');
  const $adminBody  = document.getElementById('adminBody');
  const $closeAdmin = document.getElementById('closeAdmin');
  const $editCat    = document.getElementById('editCatalogue');
  const $editorZone = document.getElementById('editorZone');
  const $exportCat  = document.getElementById('exportCat');
  const $importCat  = document.getElementById('importCat');
  const $logout     = document.getElementById('logoutAdmin');

  let isAdmin = false;

  $btnAdmin.addEventListener('click', openAdmin);
  $closeAdmin.addEventListener('click', closeAdmin);

  function openAdmin(){
    $modal.style.display='flex';
    $pinInput.value='';
    $adminBody.style.display = isAdmin ? 'block' : 'none';
  }
  function closeAdmin(){
    $modal.style.display='none';
    $editorZone.innerHTML='';
  }

  $pinOk.addEventListener('click', ()=>{
    if($pinInput.value === MANAGER_PIN){
      isAdmin = true;
      document.body.classList.add('admin');
      $adminBody.style.display='block';
    }else{
      alert('PIN incorrect');
    }
  });

  $logout.addEventListener('click', ()=>{
    isAdmin = false;
    document.body.classList.remove('admin');
    $adminBody.style.display='none';
    closeAdmin();
  });

  /* ====== Ã‰diteur de catalogue ====== */
  $editCat.addEventListener('click', ()=>{
    const cats = Object.keys(categories);
    const host = document.createElement('div');
    host.innerHTML = `
      <div class="row" style="margin-top:8px;gap:8px">
        <div style="flex:1"><strong>CatÃ©gorie :</strong></div>
        <div>
          <select class="min" id="catSel">
            ${cats.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
        </div>
        <button class="btn primary" id="addRow">+ Article</button>
        <button class="btn primary" id="saveCat">ğŸ’¾ Enregistrer</button>
      </div>
      <table class="table" id="editTable">
        <thead><tr><th>Ã‰moji</th><th>Nom</th><th>Prix (â‚¬)</th><th>ID</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    $editorZone.innerHTML = '';
    $editorZone.appendChild(host);

    const $sel   = document.getElementById('catSel');
    const $tbody = document.querySelector('#editTable tbody');

    function renderRows(){
      const list = categories[$sel.value] || [];
      $tbody.innerHTML = list.map(p=>`
        <tr data-id="${p.id}">
          <td><input value="${p.emo||''}"></td>
          <td><input value="${p.name}"></td>
          <td><input inputmode="decimal" value="${String(p.price).replace('.',',')}"></td>
          <td><input value="${p.id}"></td>
          <td><button class="btn warn del">Suppr</button></td>
        </tr>
      `).join('');
    }

    document.getElementById('addRow').onclick = ()=>{
      const nid = `item-${Date.now()}`;
      (categories[$sel.value] ||= []).push({id:nid,name:'Nouvel article',price:1.00,emo:'ğŸ§¾'});
      renderRows();
    };

    document.getElementById('saveCat').onclick = ()=>{
      const rows = [...$tbody.querySelectorAll('tr')];
      const next = rows.map(tr=>{
        const [emoEl,nameEl,priceEl,idEl] = tr.querySelectorAll('input');
        const price = parseFloat(priceEl.value.replace(',','.'))||0;
        return { id:(idEl.value.trim()||`item-${Date.now()}`), name:nameEl.value.trim(), price, emo:(emoEl.value.trim()||'ğŸ§¾') };
      });
      categories[$sel.value] = next;
      saveCatalog();
      renderTabs(); renderGrid(); updateTotals();
      alert('Catalogue enregistrÃ©.');
    };

    $tbody.addEventListener('click', (e)=>{
      if(e.target.classList.contains('del')){
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        categories[$sel.value] = (categories[$sel.value]||[]).filter(p=>p.id!==id);
        tr.remove();
      }
    });

    $sel.addEventListener('change', renderRows);
    renderRows();
  });

  /* ====== Export / Import JSON ====== */
  $exportCat.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(categories,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'catalogue-bar.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $importCat.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== 'object') throw new Error('format');
      categories = obj;
      saveCatalog();
      renderTabs(); renderGrid(); updateTotals();
      alert('Catalogue importÃ©.');
    }catch{
      alert('Import invalide.');
    }finally{
      e.target.value = '';
    }
  });
  </script>

  <footer style="text-align:center; font-size:12px; color:#666; margin:20px 0;">
    Â© 2025 - RÃ©alisÃ© par DRJ_SG08
  </footer>
</body>
</html>
